/* ========================================================================= */
/* STUDENT RCL VINTAGE CURVES - V2 CLEAN & OPTIMIZED                      */
/* Purpose: Streamlined vintage curve analysis - reduced and organized      */
/* ========================================================================= */

/* CHUNK 1: TACTIC DETAILS FOUNDATION - SINGLE OPTIMIZED QUERY */
proc sql;
    %connectsql;
    create table tactic_details as
    select * from connection to teradata (
        SELECT DISTINCT
            tactic.clnt_no,
            tactic.TACTIC_ID,
            tactic.TREATMT_STRT_DT,
            tactic.TREATMT_END_DT,
            tactic.TST_GRP_CD,
            tactic.RPT_GRP_CD,
            tactic.TREATMT_MN,
            PER.EMPL_STS_CD,
            PER.OCCPT_CD,
            
            /* STUDENT SEGMENT FLAGS - Convert Y/N to 1/0 */
            CASE 
                WHEN TACTIC.tactic_id = '2024196SLC' AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student NG')+13, 1)) = 'Y'
                THEN 1
                WHEN TACTIC.tactic_id = '2025196SLC' AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student NG')+12, 1)) = 'Y'
                THEN 1
                ELSE 0
            END AS STUDENT_NG_IND,
            
            CASE 
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC') AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student SB')+12, 1)) = 'Y'
                THEN 1 
                ELSE 0
            END AS STUDENT_SB_IND,
            
            CASE 
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC') AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student IR')+12, 1)) = 'Y'
                THEN 1 
                ELSE 0
            END AS STUDENT_IR_IND,
            
            /* GRADUATION DATE */
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC')
                AND TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 3)) = 'N/A'
                THEN 'N/A'
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC')
                AND TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 3)) <> 'N/A'
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 10))
                ELSE NULL
            END AS GRAD_DATE,
            
            /* COMMUNICATION CHANNEL FLAGS - Convert Y/N to 1/0 */
            CASE 
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC') AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'EM Ind:')+8, 1)) = 'Y'
                THEN 1 
                ELSE 0
            END AS EM_IND,
            
            CASE 
                WHEN TACTIC.tactic_id IN ('2024196SLC', '2025196SLC') AND 
                     TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'OLB Ind:')+9, 1)) = 'Y'
                THEN 1 
                ELSE 0
            END AS OLB_IND,
            
            /* CHANNEL ASSIGNMENT - Consolidated logic */
            CASE
                /* 2024 Campaign Logic */
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2022 AND RPT_GRP_CD IN ('PSLCRG01', 'PSLCRG02') THEN 'EM'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD = 'PSLCRG02' THEN 'EM'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD = 'PSLCRG01' THEN 'IM_MB'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD = 'PSLCRG03' THEN 'IM_MB_EM'
                
                /* 2025 First Campaign Logic */
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC001A' THEN 'IM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC003A' THEN 'IM_EM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC005A' THEN 'IM_EM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = 'PSLCNMAA' THEN 'CONTROL'
                
                /* 2025 Reminder Logic */
                WHEN TACTIC.tactic_id = '2025227SLC' THEN 'EM'
                
                ELSE 'OTHER'
            END AS FULL_CHANNEL
            
        FROM DG6V01.TACTIC_EVNT_IP_AR_HIST AS tactic
        LEFT JOIN (
            SELECT distinct CLNT_NO, SNAP_DT, OCCPT_CD, empl_sts_CD
            FROM DDWV01.PERS_dly
            where SNAP_DT = '2025-10-31'
        ) as PER
            on tactic.CLNT_NO = PER.CLNT_NO
        WHERE TACTIC.tactic_id IN ('2024196SLC', '2025196SLC', '2025227SLC')
        order by TACTIC.CLNT_NO
    );
quit;

/* VALIDATION SUMMARY */
proc sql;
    title "CHUNK 1 - Tactic Details Foundation Summary";
    select 
        tactic_id,
        tst_grp_cd,
        count(*) as total_clients,
        sum(STUDENT_NG_IND) as student_ng_count,
        sum(STUDENT_SB_IND) as student_sb_count, 
        sum(STUDENT_IR_IND) as student_ir_count,
        sum(EM_IND) as email_enabled,
        sum(OLB_IND) as olb_enabled
    from tactic_details
    group by tactic_id, tst_grp_cd
    order by tactic_id, tst_grp_cd;
quit;

%put =======================================================================;
%put CHUNK 1 COMPLETE - CLEAN TACTIC DETAILS FOUNDATION;
%put =======================================================================;
%put - Single optimized query (vs 4+ steps in bloated version);
%put - Fixed Y/N to 1/0 conversion for student segments;  
%put - Same business logic, cleaner implementation;
%put - Ready for Chunk 2: Email integration;
%put =======================================================================;
