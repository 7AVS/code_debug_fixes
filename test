/* ========================================================================= */
/* STUDENT RCL VINTAGE CURVES - V2 EXACT COPY WITH CONSOLIDATION           */
/* Purpose: EXACT same logic as original, just reduce bloat                 */
/* ========================================================================= */

/* CHUNK 1: EXACT TACTIC DETAILS COPY - Same hardcoded parsing, fixed tactic IDs */
proc sql;
    %connectsql;
    create table tactic_details as
    select * from connection to teradata (
        SELECT DISTINCT
            tactic.clnt_no,
            tactic.TACTIC_ID,
            tactic.TREATMT_STRT_DT,
            tactic.TREATMT_END_DT,
            tactic.TST_GRP_CD,
            tactic.RPT_GRP_CD,
            tactic.TREATMT_MN,
            PER.EMPL_STS_CD,
            PER.OCCPT_CD,
            
            /* Parse student segment flags from TACTIC_DECISN_VRB_INFO - EXACT ORIGINAL LOGIC */
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student NG')+13, 1))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student NG')+12, 1))
                ELSE NULL
            END AS STUDENT_NG_IND,
            
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student SB')+12, 1))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student SB')+12, 1))
                ELSE NULL
            END AS STUDENT_SB_IND,
            
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student IR')+12, 1))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Student IR')+12, 1))
                ELSE NULL
            END AS STUDENT_IR_IND,
            
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                AND TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 3)) = 'N/A'
                THEN 'N/A'
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                AND TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 3)) NE 'N/A'
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 10))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                AND TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 3)) NE 'N/A'
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'Grad Date:')+11, 10))
                ELSE NULL
            END AS GRAD_DATE,
            
            /* Communication channel indicators - EXACT ORIGINAL LOGIC */
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'EM Ind:')+8, 1))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'EM Ind:')+8, 1))
                ELSE NULL
            END AS EM_IND,
            
            CASE
                WHEN TACTIC.tactic_id IN ('2024196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'OLB Ind:')+9, 1))
                WHEN TACTIC.tactic_id IN ('2025196SLC')
                THEN TRIM(SUBSTR(tactic.TACTIC_DECISN_VRB_INFO, INDEX(tactic.TACTIC_DECISN_VRB_INFO, 'OLB Ind:')+9, 1))
                ELSE NULL
            END AS OLB_IND,
            
            /* Full channel assignment - EXACT ORIGINAL LOGIC */
            CASE
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2022 AND RPT_GRP_CD IN ('PSLCRG01', 'PSLCRG02') THEN 'EM'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD IN ('PSLCRG02') THEN 'EM'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD IN ('PSLCRG01') THEN 'IM_MB'
                WHEN YEAR(TACTIC.TREATMT_STRT_DT) = 2024 AND RPT_GRP_CD IN ('PSLCRG03') THEN 'IM_MB_EM'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC001A' THEN 'IM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC002A' THEN 'EM'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC003A' THEN 'IM_EM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = 'PSLCNMAA' THEN 'CONTROL'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '1SLC004A' THEN 'IM_MB'
                WHEN TACTIC.tactic_id = '2025196SLC' AND TACTIC.TREATMT_MN = '18LC005A' THEN 'IM_EM_MB'
                WHEN TACTIC.tactic_id = '2025227SLC' THEN 'EM'
                ELSE 'OTHER'
            END AS FULL_CHANNEL
            
        FROM DG6V01.TACTIC_EVNT_IP_AR_HIST AS tactic
        LEFT JOIN (
            SELECT distinct
                CLNT_NO,
                SNAP_DT,
                OCCPT_CD,
                OCCPT_CD_DESC_EN,
                empl_sts_CD
            FROM DDWV01.PERS_dly
            where SNAP_DT = '2025-10-31'
        ) as PER
        on tactic.CLNT_NO = PER.CLNT_NO
        AND PER.SNAP_DT = '2025-10-31'
        WHERE TACTIC.tactic_id IN ('2024196SLC', '2025196SLC', '2025227SLC')
        order by TACTIC.CLNT_NO
    );
quit;

/* Simple validation - same as original */
proc sql;
    title "Tactic Details Validation";
    select 
        TACTIC_ID,
        TST_GRP_CD,
        count(distinct CLNT_NO) as client_count
    from tactic_details
    group by TACTIC_ID, TST_GRP_CD
    order by TACTIC_ID, TST_GRP_CD;
quit;

%put CHUNK 1 COMPLETE - EXACT TACTIC DETAILS WITH CORRECTED TACTIC IDS;

/* ========================================================================= */
/* CHUNK 2: APPOINTMENTS SUCCESS - ACTIVITY-ONLY TABLE                     */
/* Contains ONLY clients who had appointment activity (booked or kept)     */
/* ========================================================================= */

proc sql;
    %connectsql;
    create table appointments_success as
    select * from connection to teradata (
        SELECT
            camp.clnt_no,
            camp.tactic_id,
            camp.tst_grp_cd,
            camp.rpt_grp_cd,
            camp.TREATMT_MN,
            camp.treatmt_strt_dt as campaign_start,
            camp.treatmt_end_dt as campaign_end,
            
            /* Appointment success metrics - aggregated to client level */
            max(case when evt.strt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt then 1 else 0 end) as APPT_BOOKED,
            max(case when evt.evnt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt and rslt.sub_rslt_typ_cd >= 1 then 1 else 0 end) as APPT_KEPT,
            sum(case when evt.strt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt then 1 else 0 end) as num_appts_booked,
            sum(case when evt.evnt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt and rslt.sub_rslt_typ_cd >= 1 then 1 else 0 end) as num_appts_kept,
            min(evt.strt_dt) as first_booked_date,
            max(evt.strt_dt) as last_booked_date,
            min(case when evt.evnt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt and rslt.sub_rslt_typ_cd >= 1 then evt.evnt_dt else null end) as first_kept_date,
            max(case when evt.evnt_dt between camp.treatmt_strt_dt and camp.treatmt_end_dt and rslt.sub_rslt_typ_cd >= 1 then evt.evnt_dt else null end) as last_kept_date
            
        FROM DG6V01.TACTIC_EVNT_IP_AR_HIST AS camp
        INNER JOIN DG6V01.intcn_cntct_evnt_dly_d AS evt
            ON evt.clnt_no = camp.clnt_no
            AND evt.sys_src_id = 551
            AND evt.cntct_evnt_typ = 1
            AND evt.cntct_mthd_typ IN (1,2,9)
            AND (
                evt.strt_dt BETWEEN camp.treatmt_strt_dt AND camp.treatmt_end_dt
                OR evt.evnt_dt BETWEEN camp.treatmt_strt_dt AND camp.treatmt_end_dt
            )
        LEFT JOIN DG6V01.intcn_cntct_evnt_rslt_dly AS rslt
            ON rslt.css_event_id = evt.css_event_id
            AND rslt.sys_src_id = evt.sys_src_id
            AND rslt.clnt_no = evt.clnt_no
            AND rslt.snap_dt = date '2025-11-06'
        WHERE camp.tactic_id IN ('2024196SLC', '2025196SLC', '2025227SLC')
        GROUP BY camp.clnt_no, camp.tactic_id, camp.tst_grp_cd, camp.rpt_grp_cd, camp.TREATMT_MN, camp.treatmt_strt_dt, camp.treatmt_end_dt
        ORDER BY camp.clnt_no, camp.tactic_id
    );
quit;

/* Validation */
proc sql;
    title "CHUNK 2 - Appointments Success (Activity Only)";
    select 
        tactic_id,
        tst_grp_cd,
        count(distinct clnt_no) as clients_with_appointments,
        sum(APPT_BOOKED) as clients_booked,
        sum(APPT_KEPT) as clients_kept,
        sum(num_appts_booked) as total_appts_booked,
        sum(num_appts_kept) as total_appts_kept
    from appointments_success
    group by tactic_id, tst_grp_cd
    order by tactic_id, tst_grp_cd;
quit;

%put CHUNK 2 COMPLETE - APPOINTMENTS SUCCESS (ACTIVITY ONLY);
