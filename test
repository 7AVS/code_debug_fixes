"""
VVD Acquisition Success Detection
Campaigns: VCN (30-day window), VDA (90-day window)
Success Metric: New card issued (ISS_DT within measurement window)
"""

from pyspark.sql import SparkSession
from pyspark.sql import functions as F
from pyspark import StorageLevel

# Initialize Spark (if not already running)
spark = SparkSession.builder \
    .appName("VVD Acquisition Success") \
    .getOrCreate()

# =============================================================================
# STEP 1: Load tactic DataFrame and filter for acquisition campaigns
# =============================================================================

tactic = spark.read.parquet("/user/427966379/tactic.parquet")

# Filter for acquisition campaigns only (VCN and VDA)
acquisition_campaigns = tactic.filter(
    F.col("MNE").isin(["VCN", "VDA"])
)

# =============================================================================
# STEP 2: Add measurement_end_dt based on campaign type
# =============================================================================

# VCN = 30 days, VDA = 90 days
acquisition_campaigns = acquisition_campaigns.withColumn(
    "measurement_end_dt",
    F.when(F.col("MNE") == "VCN", F.date_add(F.col("TREATMT_STRT_DT"), 30))
     .when(F.col("MNE") == "VDA", F.date_add(F.col("TREATMT_STRT_DT"), 90))
)

# Alias for join
acq = acquisition_campaigns.alias("acq")

# =============================================================================
# STEP 3: Load Visa Card Data (for acquisition/issuance)
# =============================================================================

# Read card issuance data - adjust years as needed
visa_card = spark.read.parquet(
    "/prod/sz/tsz/00050/data/DDWTA_VISA_DR_CRD/PartitionColumn=Latest/CAPTR_DT=2024*",
    "/prod/sz/tsz/00050/data/DDWTA_VISA_DR_CRD/PartitionColumn=Latest/CAPTR_DT=2025*"
)

# Select relevant columns and alias
visa_card_select = visa_card.select(
    F.col("CLNT_NO").alias("CARD_CLNT_NO"),
    "ISS_DT",
    "ACTV_DT"
).alias("card")

# =============================================================================
# STEP 4: Left join to identify acquisition success
# =============================================================================

# Join condition: 
# - Client match
# - Card issued within measurement window (ISS_DT between treatment start and end)

acquisition_with_success = acq.join(
    visa_card_select,
    (F.col("acq.CLNT_NO") == F.col("card.CARD_CLNT_NO")) &
    (F.col("card.ISS_DT") >= F.col("acq.TREATMT_STRT_DT")) &
    (F.col("card.ISS_DT") <= F.col("acq.measurement_end_dt")),
    how="left"
)

# =============================================================================
# STEP 5: Calculate days to success (keep ISS_DT for aggregation)
# =============================================================================

acquisition_final = acquisition_with_success.withColumn(
    "DAYS_TO_ACQUISITION",
    F.when(
        F.col("card.ISS_DT").isNotNull(),
        F.datediff(F.col("card.ISS_DT"), F.col("acq.TREATMT_STRT_DT"))
    ).otherwise(None)
)

# =============================================================================
# STEP 6: Aggregate to client-deployment level (capture first success + count)
# =============================================================================

# One row per client per deployment
# - First success date and days for vintage curves
# - Count for volume analysis
acquisition_result = acquisition_final.groupBy(
    "acq.CLNT_NO",
    "acq.TACTIC_ID",
    "acq.TREATMT_STRT_DT",
    "acq.CAMPAIGN_NAME",
    "acq.CHANNEL",
    "acq.MNE",
    "measurement_end_dt"
).agg(
    # Success flag (1 if at least one acquisition)
    F.max(F.when(F.col("card.ISS_DT").isNotNull(), 1).otherwise(0)).alias("ACQUISITION_SUCCESS"),
    
    # First acquisition date (for vintage curve)
    F.min("card.ISS_DT").alias("FIRST_ACQUISITION_DT"),
    
    # Days to first acquisition (for vintage curve)
    F.min("DAYS_TO_ACQUISITION").alias("DAYS_TO_FIRST_ACQUISITION"),
    
    # Total cards acquired (for volume analysis)
    F.count("card.ISS_DT").alias("ACQUISITION_COUNT")
)

# =============================================================================
# STEP 7: Output
# =============================================================================

# Show sample results
acquisition_result.show(20)

# Print summary stats
print("=== Acquisition Success Summary ===")
acquisition_result.groupBy("MNE").agg(
    F.count("*").alias("TOTAL_DEPLOYMENTS"),
    F.sum("ACQUISITION_SUCCESS").alias("SUCCESSES"),
    F.avg("ACQUISITION_SUCCESS").alias("SUCCESS_RATE"),
    F.avg("DAYS_TO_FIRST_ACQUISITION").alias("AVG_DAYS_TO_FIRST_ACQUISITION"),
    F.sum("ACQUISITION_COUNT").alias("TOTAL_CARDS_ACQUIRED"),
    F.avg("ACQUISITION_COUNT").alias("AVG_CARDS_PER_SUCCESS")
).show()

# Optional: Save results
# acquisition_result.write.parquet("/user/427966379/acquisition_success.parquet", mode="overwrite")
