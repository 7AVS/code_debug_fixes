/* ========================================================================= */
/* TARGETED VINTAGE SUMMARY - WIDE FORMAT TABLE                            */
/* Purpose: Generate wide-format analytical table for Targeted Component    */
/* Input: master_client_data (Table with columns from metadata_fields.md)   */
/* Output: vintage_summary_wide                                             */

/* ========================================================================= */

/* Create period table for days 0-120 */
DATA period_table;
    DO period_day = 0 TO 120;
        OUTPUT;
    END;
RUN;
PROC SQL;
    CREATE TABLE vintage_summary_wide AS 
    SELECT
        /* ----------------------------------------------------------------- */
        /* COHORT & GROUP DEFINITIONS                                        */
        /* ----------------------------------------------------------------- */
        CASE 
            WHEN tactic_id='2024196SLC' THEN '2024' 
            WHEN tactic_id='2025196SLC' THEN '2025_First' 
            WHEN tactic_id='2025227SLC' THEN '2025_Reminder' 
            ELSE 'Unknown' 
        END AS Cohort,
        
        CASE 
            WHEN tactic_id='2025196SLC' AND tst_grp_cd='TG1' THEN 'Action_A'
            WHEN tactic_id='2025196SLC' AND tst_grp_cd='TG4' THEN 'Action_B'
            WHEN tactic_id='2025196SLC' AND tst_grp_cd IN ('TG1', 'TG4') THEN 'Action_Combined'
            WHEN tst_grp_cd='TG7' THEN 'Control'
            WHEN tst_grp_cd IN ('TG1', 'TG4') THEN 'Action'
            ELSE tst_grp_cd 
        END AS Test_Group,
        
        period.period_day AS Period,
        
        /* ----------------------------------------------------------------- */
        /* ADDITIONAL CATEGORIES                                             */
        /* ----------------------------------------------------------------- */
        TREATMT_END_DT,
        TST_GRP_CD AS Original_Test_Group,
        GRAD_DATE,
        also_in_reminder,
        
        /* Placeholders for Missing Fields */
        . AS NTB,
        '' AS purpose LENGTH=20,
        '' AS sub_purpose LENGTH=20,
        
        /* ----------------------------------------------------------------- */
        /* METRICS (COLUMNS)                                                 */
        /* ----------------------------------------------------------------- */
        
        /* --- APPOINTMENTS --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN APPT_KEPT
                WHEN first_kept_date <= (TREATMT_STRT_DT + period.period_day) THEN APPT_KEPT
                ELSE 0 
            END
        ) AS Sum_APPT_KEPT,
        
        /* --- APPLICATIONS (STUDENT) --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN loc_student
                WHEN first_app_date_student <= (TREATMT_STRT_DT + period.period_day) THEN loc_student
                ELSE 0 
            END
        ) AS Sum_APP_TOTAL_STUDENT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN st_student_opn
                WHEN first_opened_date_student <= (TREATMT_STRT_DT + period.period_day) THEN st_student_opn
                ELSE 0 
            END
        ) AS Sum_APP_OPEN_STUDENT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN st_student_nopn
                WHEN first_app_date_student <= (TREATMT_STRT_DT + period.period_day) THEN st_student_nopn
                ELSE 0 
            END
        ) AS Sum_APP_CANCEL_STUDENT,
        
        /* --- APPLICATIONS (OTHER) --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN total_apps_other
                WHEN first_app_date_other <= (TREATMT_STRT_DT + period.period_day) THEN total_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_TOTAL_OTHER,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN opened_apps_other
                WHEN first_opened_date_other <= (TREATMT_STRT_DT + period.period_day) THEN opened_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_OPEN_OTHER,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN cancelled_apps_other
                WHEN first_app_date_other <= (TREATMT_STRT_DT + period.period_day) THEN cancelled_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_CANCEL_OTHER,
        
        /* --- EMAIL METRICS --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN num_emails_opened > 0 THEN 1 ELSE 0 END)
                WHEN first_open_date <= (TREATMT_STRT_DT + period.period_day) THEN (CASE WHEN num_emails_opened > 0 THEN 1 ELSE 0 END)
                ELSE 0 
            END
        ) AS Sum_EMAIL_OPENED,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN num_emails_clicked > 0 THEN 1 ELSE 0 END)
                WHEN first_click_date <= (TREATMT_STRT_DT + period.period_day) THEN (CASE WHEN num_emails_clicked > 0 THEN 1 ELSE 0 END)
                ELSE 0 
            END
        ) AS Sum_EMAIL_CLICKED,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN EMAIL_UNSUBSCRIBED
                WHEN TREATMT_END_DT <= (TREATMT_STRT_DT + period.period_day) THEN EMAIL_UNSUBSCRIBED
                ELSE 0 
            END
        ) AS Sum_EMAIL_UNSUBSCRIBED,
        
        /* --- FULFILLMENT METRICS --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN total_cash_offers > 0 AND CASH_AMT=200 THEN 1 ELSE 0 END)
                WHEN first_offer_date <= (TREATMT_STRT_DT + period.period_day) AND CASH_AMT=200 THEN 1
                ELSE 0 
            END
        ) AS Sum_FULFILL_200,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN total_cash_offers > 0 AND CASH_AMT=575 THEN 1 ELSE 0 END)
                WHEN first_offer_date <= (TREATMT_STRT_DT + period.period_day) AND CASH_AMT=575 THEN 1
                ELSE 0 
            END
        ) AS Sum_FULFILL_575,
        
        COUNT(*) AS Base_Count
        
    FROM master_client_data 
    CROSS JOIN period_table period
    WHERE period.period_day BETWEEN 0 AND 120 
    GROUP BY 
        (CASE 
            WHEN tactic_id='2024196SLC' THEN '2024' 
            WHEN tactic_id='2025196SLC' THEN '2025_First' 
            WHEN tactic_id='2025227SLC' THEN '2025_Reminder' 
            ELSE 'Unknown' 
        END),
        (CASE 
            WHEN tactic_id='2025196SLC' AND tst_grp_cd='TG1' THEN 'Action_A'
            WHEN tactic_id='2025196SLC' AND tst_grp_cd='TG4' THEN 'Action_B'
            WHEN tactic_id='2025196SLC' AND tst_grp_cd IN ('TG1', 'TG4') THEN 'Action_Combined'
            WHEN tst_grp_cd='TG7' THEN 'Control'
            WHEN tst_grp_cd IN ('TG1', 'TG4') THEN 'Action'
            ELSE tst_grp_cd 
        END),
        period.period_day, TREATMT_END_DT, TST_GRP_CD, GRAD_DATE, also_in_reminder
    
    /* ----------------------------------------------------------------- */
    /* ACTION COMBINED LOGIC (UNION ALL)                                 */
    /* ----------------------------------------------------------------- */
    UNION ALL 
    SELECT 
        '2025_First' AS Cohort,
        'Action_Combined' AS Test_Group,
        period.period_day AS Period,
        TREATMT_END_DT,
        TST_GRP_CD AS Original_Test_Group,
        GRAD_DATE,
        also_in_reminder,
        . AS NTB,
        '' AS purpose,
        '' AS sub_purpose,
        
        /* --- REPEAT METRIC SUMS --- */
        SUM(
            CASE 
                WHEN period.period_day=0 THEN APPT_KEPT
                WHEN first_kept_date <= (TREATMT_STRT_DT + period.period_day) THEN APPT_KEPT
                ELSE 0 
            END
        ) AS Sum_APPT_KEPT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN loc_student
                WHEN first_app_date_student <= (TREATMT_STRT_DT + period.period_day) THEN loc_student
                ELSE 0 
            END
        ) AS Sum_APP_TOTAL_STUDENT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN st_student_opn
                WHEN first_opened_date_student <= (TREATMT_STRT_DT + period.period_day) THEN st_student_opn
                ELSE 0 
            END
        ) AS Sum_APP_OPEN_STUDENT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN st_student_nopn
                WHEN first_app_date_student <= (TREATMT_STRT_DT + period.period_day) THEN st_student_nopn
                ELSE 0 
            END
        ) AS Sum_APP_CANCEL_STUDENT,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN total_apps_other
                WHEN first_app_date_other <= (TREATMT_STRT_DT + period.period_day) THEN total_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_TOTAL_OTHER,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN opened_apps_other
                WHEN first_opened_date_other <= (TREATMT_STRT_DT + period.period_day) THEN opened_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_OPEN_OTHER,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN cancelled_apps_other
                WHEN first_app_date_other <= (TREATMT_STRT_DT + period.period_day) THEN cancelled_apps_other
                ELSE 0 
            END
        ) AS Sum_APP_CANCEL_OTHER,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN num_emails_opened > 0 THEN 1 ELSE 0 END)
                WHEN first_open_date <= (TREATMT_STRT_DT + period.period_day) THEN (CASE WHEN num_emails_opened > 0 THEN 1 ELSE 0 END)
                ELSE 0 
            END
        ) AS Sum_EMAIL_OPENED,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN num_emails_clicked > 0 THEN 1 ELSE 0 END)
                WHEN first_click_date <= (TREATMT_STRT_DT + period.period_day) THEN (CASE WHEN num_emails_clicked > 0 THEN 1 ELSE 0 END)
                ELSE 0 
            END
        ) AS Sum_EMAIL_CLICKED,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN EMAIL_UNSUBSCRIBED
                WHEN TREATMT_END_DT <= (TREATMT_STRT_DT + period.period_day) THEN EMAIL_UNSUBSCRIBED
                ELSE 0 
            END
        ) AS Sum_EMAIL_UNSUBSCRIBED,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN total_cash_offers > 0 AND CASH_AMT=200 THEN 1 ELSE 0 END)
                WHEN first_offer_date <= (TREATMT_STRT_DT + period.period_day) AND CASH_AMT=200 THEN 1
                ELSE 0 
            END
        ) AS Sum_FULFILL_200,
        
        SUM(
            CASE 
                WHEN period.period_day=0 THEN (CASE WHEN total_cash_offers > 0 AND CASH_AMT=575 THEN 1 ELSE 0 END)
                WHEN first_offer_date <= (TREATMT_STRT_DT + period.period_day) AND CASH_AMT=575 THEN 1
                ELSE 0 
            END
        ) AS Sum_FULFILL_575,
        
        COUNT(*) AS Base_Count
        
    FROM master_client_data 
    CROSS JOIN period_table period
    WHERE period.period_day BETWEEN 0 AND 120 
        AND tactic_id='2025196SLC' 
        AND tst_grp_cd IN ('TG1', 'TG4') 
    GROUP BY 
        '2025_First',
        'Action_Combined',
        period.period_day, TREATMT_END_DT, TST_GRP_CD, GRAD_DATE, also_in_reminder 
    ORDER BY Cohort, Test_Group, Period;
QUIT;
