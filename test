"""
VVD Acquisition Success Detection
Campaigns: VCN (30-day window), VDA (90-day window)
Success Metric: New card issued (ISS_DT within measurement window)
"""

from pyspark.sql import SparkSession
from pyspark.sql import functions as F
from pyspark.sql.window import Window
from pyspark import StorageLevel
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

# Initialize Spark (if not already running)
spark = SparkSession.builder \
    .appName("VVD Acquisition Success") \
    .getOrCreate()

# =============================================================================
# STEP 1: Load tactic DataFrame and filter for acquisition campaigns
# =============================================================================

tactic = spark.read.parquet("/user/427966379/tactic.parquet")

# Get all tactic column names for later use
tactic_columns = tactic.columns

# Filter for acquisition campaigns only (VCN and VDA)
acquisition_campaigns = tactic.filter(
    F.col("MNE").isin(["VCN", "VDA"])
)

# =============================================================================
# STEP 2: Add measurement_end_dt based on campaign type
# =============================================================================

# VCN = 30 days, VDA = 90 days
acquisition_campaigns = acquisition_campaigns.withColumn(
    "measurement_end_dt",
    F.when(F.col("MNE") == "VCN", F.date_add(F.col("TREATMT_STRT_DT"), 30))
     .when(F.col("MNE") == "VDA", F.date_add(F.col("TREATMT_STRT_DT"), 90))
)

# Alias for join
acq = acquisition_campaigns.alias("acq")

# =============================================================================
# STEP 3: Load Visa Card Data (for acquisition/issuance)
# =============================================================================

# Read card issuance data - adjust years as needed
visa_card = spark.read.parquet(
    "/prod/sz/tsz/00050/data/DDWTA_VISA_DR_CRD/PartitionColumn=Latest/CAPTR_DT=2024*",
    "/prod/sz/tsz/00050/data/DDWTA_VISA_DR_CRD/PartitionColumn=Latest/CAPTR_DT=2025*"
)

# Select relevant columns and alias
visa_card_select = visa_card.select(
    F.col("CLNT_NO").alias("CARD_CLNT_NO"),
    "ISS_DT",
    "ACTV_DT"
).alias("card")

# =============================================================================
# STEP 4: Left join to identify acquisition success
# =============================================================================

# Join condition: 
# - Client match
# - Card issued within measurement window (ISS_DT between treatment start and end)

acquisition_with_success = acq.join(
    visa_card_select,
    (F.col("acq.CLNT_NO") == F.col("card.CARD_CLNT_NO")) &
    (F.col("card.ISS_DT") >= F.col("acq.TREATMT_STRT_DT")) &
    (F.col("card.ISS_DT") <= F.col("acq.measurement_end_dt")),
    how="left"
)

# =============================================================================
# STEP 5: Calculate days to success (keep ISS_DT for aggregation)
# =============================================================================

acquisition_final = acquisition_with_success.withColumn(
    "DAYS_TO_ACQUISITION",
    F.when(
        F.col("card.ISS_DT").isNotNull(),
        F.datediff(F.col("card.ISS_DT"), F.col("acq.TREATMT_STRT_DT"))
    ).otherwise(None)
)

# =============================================================================
# STEP 6: Aggregate to client-deployment level (capture first success + count)
# =============================================================================

# Build groupBy columns - all tactic fields plus measurement_end_dt
groupby_columns = [f"acq.{col}" for col in tactic_columns] + ["measurement_end_dt"]

# One row per client per deployment
# - First success date and days for vintage curves
# - Count for volume analysis
acquisition_result = acquisition_final.groupBy(
    groupby_columns
).agg(
    # Success flag (1 if at least one acquisition)
    F.max(F.when(F.col("card.ISS_DT").isNotNull(), 1).otherwise(0)).alias("ACQUISITION_SUCCESS"),
    
    # First acquisition date (for vintage curve)
    F.min("card.ISS_DT").alias("FIRST_ACQUISITION_DT"),
    
    # Days to first acquisition (for vintage curve)
    F.min("DAYS_TO_ACQUISITION").alias("DAYS_TO_FIRST_ACQUISITION"),
    
    # Total cards acquired (for volume analysis)
    F.count("card.ISS_DT").alias("ACQUISITION_COUNT")
)

# =============================================================================
# STEP 7: Output
# =============================================================================

# Show sample results
acquisition_result.show(20)

# Print summary stats
print("=== Acquisition Success Summary ===")
acquisition_result.groupBy("MNE").agg(
    F.count("*").alias("TOTAL_DEPLOYMENTS"),
    F.sum("ACQUISITION_SUCCESS").alias("SUCCESSES"),
    F.avg("ACQUISITION_SUCCESS").alias("SUCCESS_RATE"),
    F.avg("DAYS_TO_FIRST_ACQUISITION").alias("AVG_DAYS_TO_FIRST_ACQUISITION"),
    F.sum("ACQUISITION_COUNT").alias("TOTAL_CARDS_ACQUIRED"),
    F.avg("ACQUISITION_COUNT").alias("AVG_CARDS_PER_SUCCESS")
).show()

# =============================================================================
# STEP 8: Vintage Curve for VCN - Action Group (TG4) Only
# =============================================================================

# Filter for VCN and TG4 (action group)
vcn_tg4 = acquisition_result.filter(
    (F.col("MNE") == "VCN") & 
    (F.col("TST_GRP_CD") == "TG4")
)

# Create cohort label (YYYY-MM format for readability)
vcn_tg4 = vcn_tg4.withColumn(
    "COHORT",
    F.date_format(F.col("TREATMT_STRT_DT"), "yyyy-MM")
)

# Get total clients per cohort
cohort_totals = vcn_tg4.groupBy("COHORT").agg(
    F.count("*").alias("TOTAL_CLIENTS")
)

print("\n=== VCN TG4 Cohort Summary ===")
cohort_totals.orderBy("COHORT").show(50)

# Calculate successes by cohort and day
vintage_data = vcn_tg4.filter(
    F.col("ACQUISITION_SUCCESS") == 1
).groupBy("COHORT", "DAYS_TO_FIRST_ACQUISITION").agg(
    F.count("*").alias("SUCCESSES_ON_DAY")
).orderBy("COHORT", "DAYS_TO_FIRST_ACQUISITION")

# Join with cohort totals to calculate rates
vintage_data = vintage_data.join(cohort_totals, on="COHORT", how="left")

# Convert to Pandas for plotting
vintage_pdf = vintage_data.toPandas()
cohort_totals_pdf = cohort_totals.toPandas()

# Calculate cumulative successes and rate per cohort
vintage_pdf = vintage_pdf.sort_values(["COHORT", "DAYS_TO_FIRST_ACQUISITION"])
vintage_pdf["CUMULATIVE_SUCCESSES"] = vintage_pdf.groupby("COHORT")["SUCCESSES_ON_DAY"].cumsum()
vintage_pdf["CUMULATIVE_SUCCESS_RATE"] = vintage_pdf["CUMULATIVE_SUCCESSES"] / vintage_pdf["TOTAL_CLIENTS"] * 100

print("\nVintage Data (sample):")
print(vintage_pdf.head(20))

# =============================================================================
# STEP 9: Plot Vintage Curve - One Line Per Cohort
# =============================================================================

plt.figure(figsize=(12, 7))

# Get unique cohorts and assign colors
cohorts = sorted(vintage_pdf["COHORT"].unique())
colors = plt.cm.viridis(np.linspace(0, 1, len(cohorts)))

for i, cohort in enumerate(cohorts):
    cohort_data = vintage_pdf[vintage_pdf["COHORT"] == cohort]
    plt.plot(
        cohort_data["DAYS_TO_FIRST_ACQUISITION"], 
        cohort_data["CUMULATIVE_SUCCESS_RATE"],
        marker='o',
        linewidth=1.5,
        markersize=3,
        color=colors[i],
        label=cohort,
        alpha=0.8
    )

plt.xlabel("Days from Treatment", fontsize=12)
plt.ylabel("Cumulative Acquisition Rate (%)", fontsize=12)
plt.title("VCN Campaign Vintage Curves by Cohort - Action Group (TG4)\n30-Day Measurement Window", fontsize=14)
plt.grid(True, alpha=0.3)
plt.xlim(0, 30)
plt.ylim(0, None)
plt.legend(title="Cohort", bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=8)

plt.tight_layout()
plt.savefig("/user/427966379/vcn_tg4_vintage_curve_by_cohort.png", dpi=150, bbox_inches='tight')
plt.show()

print(f"\nVintage curve saved to: /user/427966379/vcn_tg4_vintage_curve_by_cohort.png")

# =============================================================================
# STEP 10: Summary Table - Final Rate by Cohort
# =============================================================================

# Get final cumulative rate for each cohort (at day 30 or last available day)
final_rates = vintage_pdf.loc[vintage_pdf.groupby("COHORT")["DAYS_TO_FIRST_ACQUISITION"].idxmax()]
final_rates = final_rates[["COHORT", "TOTAL_CLIENTS", "CUMULATIVE_SUCCESSES", "CUMULATIVE_SUCCESS_RATE"]]
final_rates = final_rates.rename(columns={
    "CUMULATIVE_SUCCESSES": "TOTAL_ACQUISITIONS",
    "CUMULATIVE_SUCCESS_RATE": "FINAL_ACQUISITION_RATE"
})
final_rates = final_rates.sort_values("COHORT")

print("\n=== Final Acquisition Rate by Cohort ===")
print(final_rates.to_string(index=False))

# Optional: Save results
# acquisition_result.write.parquet("/user/427966379/acquisition_success.parquet", mode="overwrite")
