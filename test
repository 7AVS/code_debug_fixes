Got it. Changes:
Dates moved to end
Add MNE flags (VCN_FLAG, VDA_FLAG, etc.) - 1 if ever participated, 0 if not
Keep counts
Add CPK_OLB_ELIGIBLE from UCP (I believe that's the field - it was in our earlier list)
# %% Cell 1: Setup
from pyspark.sql import functions as F
from pyspark.sql.functions import broadcast, when, col, max as spark_max, count

vvd_mne = ['VCN', 'VDA', 'VDO', 'VDT', 'VUI', 'VUT', 'VAW']


# %% Cell 2: Read Client List (Base)
client_list = spark.read.csv(
    "/user/427966379/VVD_SRF_LIST.csv",
    header=True
).select("CLNT_NO").distinct()

print(f"Total clients: {client_list.count()}")


# %% Cell 3: Get UCP Fields (4 fields now)
ucp_fields = spark.read.parquet(
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-11-30"
).select("CLNT_NO", "ACTIVE_EMAIL_IND", "OLB_ENROLLED_IND", "MOBILE_AUTH_CNT", "CPK_OLB_ELIGIBLE")

# Join to client list
client_ucp = client_list.join(broadcast(ucp_fields), on="CLNT_NO", how="left")


# %% Cell 4: Read Tactic Data (VVD only)
years = ["2024", "2025"]
paths = [f"/prod/sz/tsz/00150/cc/DTZTA_T_TACTIC_EVNT_HIST/EVNT_STRT_DT={year}*" for year in years]

tactic = spark.read.option("basePath", "/prod/sz/tsz/00150/cc/DTZTA_T_TACTIC_EVNT_HIST/") \
    .parquet(*paths) \
    .withColumn("MNE", F.substring(F.col("TACTIC_ID"), 8, 3)) \
    .withColumn("CLNT_NO", F.regexp_replace(F.trim(F.col("TACTIC_EVNT_ID")), "^0+", "")) \
    .filter(F.col("MNE").isin(vvd_mne)) \
    .select("CLNT_NO", "MNE", "TREATMT_STRT_DT")

# Join to client list only
tactic_filtered = tactic.join(broadcast(client_list), on="CLNT_NO", how="inner")


# %% Cell 5: Pivot - Count and Last Date per MNE
# Count per MNE
count_pivot = tactic_filtered.groupBy("CLNT_NO").pivot("MNE", vvd_mne).agg(
    count("*")
).na.fill(0)

# Rename columns to _COUNT
for mne in vvd_mne:
    count_pivot = count_pivot.withColumnRenamed(mne, f"{mne}_COUNT")

# Last date per MNE
date_pivot = tactic_filtered.groupBy("CLNT_NO").pivot("MNE", vvd_mne).agg(
    spark_max("TREATMT_STRT_DT")
)

# Rename columns to _LAST_DATE
for mne in vvd_mne:
    date_pivot = date_pivot.withColumnRenamed(mne, f"{mne}_LAST_DATE")


# %% Cell 6: Combine Everything
# Join count and date pivots
tactic_combined = count_pivot.join(date_pivot, on="CLNT_NO", how="outer")

# Join to client_ucp (base)
final_output = client_ucp.join(tactic_combined, on="CLNT_NO", how="left")

# Fill nulls for counts
count_cols = [f"{mne}_COUNT" for mne in vvd_mne]
final_output = final_output.na.fill(0, count_cols)

# Create MNE flags (1 if count > 0, else 0)
for mne in vvd_mne:
    final_output = final_output.withColumn(
        f"{mne}_FLAG",
        when(col(f"{mne}_COUNT") > 0, 1).otherwise(0)
    )

# Create VVD_EVER_FLAG
final_output = final_output.withColumn(
    "VVD_EVER_FLAG",
    when(
        (col("VCN_FLAG") == 1) | (col("VDA_FLAG") == 1) | (col("VDO_FLAG") == 1) |
        (col("VDT_FLAG") == 1) | (col("VUI_FLAG") == 1) | (col("VUT_FLAG") == 1) |
        (col("VAW_FLAG") == 1),
        1
    ).otherwise(0)
)

# Reorder columns - dates at the end
final_output = final_output.select(
    "CLNT_NO",
    # UCP fields
    "ACTIVE_EMAIL_IND",
    "OLB_ENROLLED_IND",
    "MOBILE_AUTH_CNT",
    "CPK_OLB_ELIGIBLE",
    # Overall flag
    "VVD_EVER_FLAG",
    # MNE flags
    "VCN_FLAG", "VDA_FLAG", "VDO_FLAG", "VDT_FLAG", "VUI_FLAG", "VUT_FLAG", "VAW_FLAG",
    # MNE counts
    "VCN_COUNT", "VDA_COUNT", "VDO_COUNT", "VDT_COUNT", "VUI_COUNT", "VUT_COUNT", "VAW_COUNT",
    # MNE dates (at end)
    "VCN_LAST_DATE", "VDA_LAST_DATE", "VDO_LAST_DATE", "VDT_LAST_DATE", "VUI_LAST_DATE", "VUT_LAST_DATE", "VAW_LAST_DATE"
)

print(f"Final output rows: {final_output.count()}")
print(f"Final output columns: {len(final_output.columns)}")
final_output.show(20, truncate=False)


# %% Cell 7: Save to CSV
final_output.coalesce(1).write.csv(
    "/user/427966379/vvd_srf_client_campaign_output",
    header=True,
    mode="overwrite"
)

print("CSV saved to /user/427966379/vvd_srf_client_campaign_output")
Column order now:
CLNT_NO
ACTIVE_EMAIL_IND, OLB_ENROLLED_IND, MOBILE_AUTH_CNT, CPK_OLB_ELIGIBLE
VVD_EVER_FLAG
VCN_FLAG, VDA_FLAG, VDO_FLAG, VDT_FLAG, VUI_FLAG, VUT_FLAG, VAW_FLAG
VCN_COUNT, VDA_COUNT, VDO_COUNT, VDT_COUNT, VUI_COUNT, VUT_COUNT, VAW_COUNT
VCN_LAST_DATE, VDA_LAST_DATE, VDO_LAST_DATE, VDT_LAST_DATE, VUI_LAST_DATE, VUT_LAST_DATE, VAW_LAST_DATE
Is this correct?