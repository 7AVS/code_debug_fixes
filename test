# =============================================================================
# UCP4 CLIENT EXTRACTION AND EDA - COMPLETE CORRECTED VERSION
# =============================================================================
# Run each cell separately in Jupyter Notebook
# =============================================================================

# %% Cell 1: Imports
from pyspark.sql.functions import broadcast, col, avg, count, when, lit, row_number
from pyspark.sql import Window
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

sns.set_style("whitegrid")


# %% Cell 2: Define Fields (CORRECTED - NO DUPLICATES)
# Fields to average (6-month avg)
avg_fields = [
    # Balances
    "CC_ALL_PR_BAL", "CC_RETAIL_ALL_PR_BAL", "INVEST_TFSA_MUTUAL_FUND_BAL",
    "LOAN_ALL_PR_BAL", "LOAN_RCL_ALL_TOT_BAL", "LOAN_RCL_SEC_TOT_BAL",
    "LOAN_RCL_STUDENT_TOT_BAL", "LOAN_RCL_UNSEC_TOT_BAL", "LOAN_TOT_BAL",
    "MORTGAGE_BAL", "PDA_TOT_BAL", "INVEST_BRANCH_TOT_BAL", "T_TOT_BAL",
    "B_TOT_BAL", "C_TOT_BAL", "MORT_TOT_BAL", "REG_SAV_TOT_BAL",
    "MF_TOT_BAL", "I_TOT_BAL",
    # Counts
    "T_TOT_CNT", "I_TOT_CNT", "B_TOT_CNT", "C_TOT_CNT", "SRVC_CNT",
    "MOBILE_AUTH_MOB_CNT", "MOBILE_AUTH_CNT", "OLB_TRANS_ETRANSFER_RCVD_CNT",
    "OFI_M_PROD_CNT", "OFI_L_PROD_CNT", "OFI_C_PROD_CNT", "OFI_T_PROD_CNT", "OFI_I_PROD_CNT",
    # Profitability & Tenure
    "PROF_TOT_ANNUAL", "PROF_TOT_MONTHLY", "TENURE_RBC_YEARS", "AGE",
    "ACTV_PROD_CNT", "ACTV_PROD_SRVC_CNT", "OPN_PROD_CNT"
]

# Fields to take latest value (CORRECTED - NO DUPLICATES)
latest_fields = [
    # Demographics
    "AGE_RNG", "GENERATION", "SEX_SEG_CD", "FSA_CD", "RESID_CNTRY_CD", "SUBCNTRY_CD",
    "CLNT_SPCFC_CD_VAL", "NXT_GEN_STUD_SEG_CD", "NEW_IMGRNT_SEG_CD", "LOG_COMP_SEG_CD",
    # Tenure & Relationship
    "TENURE_RBC_RNG", "REL_TP_SEG_CD", "ACCT_MGD_RELTN_TP_CD",
    # Credit & Risk
    "CREDIT_SCORE_RNG", "DLQY_IND", "CREDIT_PHASE_SEG_CD", "CLS_CRM_HD_CD",
    # Income
    "INCOME_AFTER_TAX_RNG", "PROF_SEG_CD",
    # Product Indicators
    "CC_VISA_ALL_TOT_IND", "CC_VISA_DR_IND", "CC_VISA_CLSIC_TOT_IND",
    "CC_VISA_CLSIC_RWD_TOT_IND", "CC_VISA_GOLD_PRFR_TOT_IND", "CC_VISA_IAV_TOT_IND",
    "CC_MASTERCARD_ALL_TOT_IND", "LOAN_TOT_IND", "MORTGAGE_RESID_TOT_IND",
    "LOAN_RCL_UNSEC_TOT_IND", "LOAN_RCL_STUDENT_TOT_IND", "LOAN_STUDENT_TOT_IND",
    "PDA_STUDENT_CURR_TOT_IND", "PDA_STUDENT_TOT_IND", "MULTI_PROD_RBT_TOT_IND",
    # Digital
    "OLB_ENROLLED_IND", "CPC_OLB_ELIGIBLE", "ACTIVE_EMAIL_IND", "MYADVISOR_STATUS",
    # Segmentation
    "CLNT_PROD_SEG_CD", "BSC",
    # Channel Preferences
    "D2D_BILL_PYMT_CHNL_PREF_SEG_CD", "D2D_DEP_CHNL_PREF_SEG_CD",
    "D2D_INFO_SEEK_CHNL_PREF_SEG_CD", "D2D_TRF_CHNL_PREF_SEG_CD", "D2D_WD_CHNL_PREF_SEG_CD"
]

# Remove any duplicates just in case
avg_fields = list(dict.fromkeys(avg_fields))
latest_fields = list(dict.fromkeys(latest_fields))

all_fields = ["CLNT_NO"] + avg_fields + latest_fields

print(f"Avg fields: {len(avg_fields)}")
print(f"Latest fields: {len(latest_fields)}")
print(f"Total fields: {len(all_fields)}")


# %% Cell 3: Define Partitions (6 months)
partitions = [
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-06-30",
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-07-31",
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-08-31",
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-09-30",
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-10-31",
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-11-30"
]


# %% Cell 4: Read Client List
client_list = spark.read.csv(
    "/user/427966379/VVD_SRF_LIST.csv",
    header=True
).select("CLNT_NO").distinct()

print(f"Clients in list: {client_list.count()}")


# %% Cell 5: Read and Combine 6 Months of UCP4
ucp4_all = None
for i, path in enumerate(partitions):
    month_data = spark.read.parquet(path).select(all_fields)
    month_data = month_data.withColumn("MONTH_ORDER", lit(i))
    
    if ucp4_all is None:
        ucp4_all = month_data
    else:
        ucp4_all = ucp4_all.union(month_data)

# Filter to client list only
ucp4_filtered = ucp4_all.join(broadcast(client_list), on="CLNT_NO", how="inner")

print(f"Total records (6 months): {ucp4_filtered.count()}")


# %% Cell 6: Aggregate - Averages and Latest Values
# Window for getting latest row
w = Window.partitionBy("CLNT_NO").orderBy(col("MONTH_ORDER").desc())

# Get latest row per client for categorical fields
latest_df = ucp4_filtered.withColumn("rn", row_number().over(w)).filter(col("rn") == 1).drop("rn", "MONTH_ORDER")

# Get averages for numeric fields
avg_df = ucp4_filtered.groupBy("CLNT_NO").agg(*[avg(col(f)).alias(f) for f in avg_fields])

# Count months per client
months_df = ucp4_filtered.groupBy("CLNT_NO").agg(count("*").alias("MONTHS_WITH_DATA"))

# Join all together
final_df = avg_df.join(latest_df.select(["CLNT_NO"] + latest_fields), on="CLNT_NO", how="inner")
final_df = final_df.join(months_df, on="CLNT_NO", how="inner")

# Add active flag
final_df = final_df.withColumn("IS_ACTIVE", when(col("ACTV_PROD_CNT") > 0, 1).otherwise(0))

print(f"Final client count: {final_df.count()}")
print(f"Total columns: {len(final_df.columns)}")


# %% Cell 7: Convert to Pandas for EDA
df = final_df.toPandas()

# Remove duplicate columns if any
df = df.loc[:, ~df.columns.duplicated()]

# Convert any remaining object numeric columns to float
for col_name in df.columns:
    if "_BAL" in col_name or "_CNT" in col_name or col_name in ["PROF_TOT_ANNUAL", "PROF_TOT_MONTHLY", "TENURE_RBC_YEARS", "AGE"]:
        df[col_name] = pd.to_numeric(df[col_name], errors='coerce')

print(f"Shape: {df.shape}")
df.head()


# =============================================================================
# EDA SECTION
# =============================================================================

# %% Cell 8: Client Overview
fig, axes = plt.subplots(1, 3, figsize=(14, 4))

# Total & Active
active_counts = df["IS_ACTIVE"].value_counts()
axes[0].bar(["Inactive", "Active"], [active_counts.get(0, 0), active_counts.get(1, 0)], color=["salmon", "seagreen"])
axes[0].set_title(f"Active vs Inactive\n(Total: {len(df)})")
axes[0].set_ylabel("Count")

# Months of data
df["MONTHS_WITH_DATA"].value_counts().sort_index().plot(kind="bar", ax=axes[1], color="steelblue")
axes[1].set_title("Months of Data per Client")
axes[1].set_xlabel("Months")
axes[1].set_ylabel("Count")

# Active product count distribution
df["ACTV_PROD_CNT"].clip(upper=10).value_counts().sort_index().plot(kind="bar", ax=axes[2], color="darkorange")
axes[2].set_title("Active Product Count")
axes[2].set_xlabel("Products (capped at 10)")
axes[2].set_ylabel("Count")

plt.tight_layout()
plt.show()

# TABLE: Client Overview
print("\n=== CLIENT OVERVIEW ===")
overview_df = pd.DataFrame({
    "Metric": ["Total Clients", "Active", "Inactive"],
    "Count": [len(df), active_counts.get(1, 0), active_counts.get(0, 0)],
    "Pct": [100.0, active_counts.get(1, 0)/len(df)*100, active_counts.get(0, 0)/len(df)*100]
})
overview_df["Pct"] = overview_df["Pct"].round(1).astype(str) + "%"
print(overview_df.to_string(index=False))


# %% Cell 9: Demographics
fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# Generation
df["GENERATION"].value_counts().plot(kind="barh", ax=axes[0, 0], color="teal")
axes[0, 0].set_title("Generation")

# Age Range
df["AGE_RNG"].value_counts().sort_index().plot(kind="bar", ax=axes[0, 1], color="coral")
axes[0, 1].set_title("Age Range")
axes[0, 1].tick_params(axis='x', rotation=45)

# Gender
df["SEX_SEG_CD"].value_counts().plot(kind="bar", ax=axes[1, 0], color="mediumpurple")
axes[1, 0].set_title("Gender")

# Top 10 FSA
df["FSA_CD"].value_counts().head(10).plot(kind="barh", ax=axes[1, 1], color="olive")
axes[1, 1].set_title("Top 10 FSA (Postal Areas)")

plt.tight_layout()
plt.show()

# TABLE: Generation
print("\n=== GENERATION ===")
gen_df = df["GENERATION"].value_counts().reset_index()
gen_df.columns = ["Generation", "Count"]
gen_df["Pct"] = (gen_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(gen_df.to_string(index=False))

# TABLE: Age Range
print("\n=== AGE RANGE ===")
age_df = df["AGE_RNG"].value_counts().sort_index().reset_index()
age_df.columns = ["Age Range", "Count"]
age_df["Pct"] = (age_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(age_df.to_string(index=False))

# TABLE: Gender
print("\n=== GENDER ===")
sex_df = df["SEX_SEG_CD"].value_counts().reset_index()
sex_df.columns = ["Gender", "Count"]
sex_df["Pct"] = (sex_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(sex_df.to_string(index=False))

# TABLE: Top 10 FSA
print("\n=== TOP 10 FSA ===")
fsa_df = df["FSA_CD"].value_counts().head(10).reset_index()
fsa_df.columns = ["FSA", "Count"]
fsa_df["Pct"] = (fsa_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(fsa_df.to_string(index=False))


# %% Cell 10: Tenure & Relationship
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Tenure Range
df["TENURE_RBC_RNG"].value_counts().plot(kind="bar", ax=axes[0], color="steelblue")
axes[0].set_title("Tenure Range")
axes[0].tick_params(axis='x', rotation=45)

# Avg Tenure Years
axes[1].hist(df["TENURE_RBC_YEARS"].dropna(), bins=20, color="seagreen", edgecolor="black")
axes[1].set_title("Tenure Years Distribution")
axes[1].set_xlabel("Years")

# Relationship Type
df["REL_TP_SEG_CD"].value_counts().plot(kind="barh", ax=axes[2], color="darkorange")
axes[2].set_title("Relationship Type")

plt.tight_layout()
plt.show()

# TABLE: Tenure Range
print("\n=== TENURE RANGE ===")
tenure_df = df["TENURE_RBC_RNG"].value_counts().reset_index()
tenure_df.columns = ["Tenure Range", "Count"]
tenure_df["Pct"] = (tenure_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(tenure_df.to_string(index=False))

# TABLE: Tenure Years Stats
print("\n=== TENURE YEARS STATS ===")
tenure_stats = df["TENURE_RBC_YEARS"].describe()[["mean", "50%", "min", "max"]].round(2)
tenure_stats.index = ["Mean", "Median", "Min", "Max"]
print(tenure_stats.to_string())

# TABLE: Relationship Type
print("\n=== RELATIONSHIP TYPE ===")
rel_df = df["REL_TP_SEG_CD"].value_counts().reset_index()
rel_df.columns = ["Rel Type", "Count"]
rel_df["Pct"] = (rel_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(rel_df.to_string(index=False))


# %% Cell 11: Product Penetration
ind_fields = [c for c in df.columns if "_IND" in c]
penetration = df[ind_fields].apply(lambda x: (x == 1).sum() / len(df) * 100).sort_values(ascending=True)

plt.figure(figsize=(10, 8))
penetration.plot(kind="barh", color="teal")
plt.title("Product Penetration (%)")
plt.xlabel("% of Clients")
plt.tight_layout()
plt.show()

# TABLE: Product Penetration
print("\n=== PRODUCT PENETRATION ===")
pen_df = pd.DataFrame({
    "Product": penetration.index,
    "Count": df[ind_fields].apply(lambda x: (x == 1).sum()).loc[penetration.index].values,
    "Pct": penetration.values.round(1)
}).sort_values("Pct", ascending=False)
pen_df["Pct"] = pen_df["Pct"].astype(str) + "%"
print(pen_df.to_string(index=False))


# %% Cell 12: Balance Summary
bal_fields = [c for c in df.columns if "_BAL" in c]

# TABLE: Balance Summary
print("\n=== BALANCE SUMMARY ===")
bal_summary = df[bal_fields].describe().T[["mean", "50%", "min", "max"]]
bal_summary.columns = ["Mean", "Median", "Min", "Max"]
bal_summary = bal_summary.round(2)
print(bal_summary.to_string())


# %% Cell 13: Balance Distributions (Top 6)
top_bal = df[bal_fields].mean().sort_values(ascending=False).head(6).index.tolist()

fig, axes = plt.subplots(2, 3, figsize=(15, 8))
axes = axes.flatten()

for i, field in enumerate(top_bal):
    df[field].clip(upper=df[field].quantile(0.95)).hist(bins=30, ax=axes[i], color="steelblue", edgecolor="black")
    axes[i].set_title(field)
    axes[i].set_xlabel("Balance (capped 95th pctl)")

plt.tight_layout()
plt.show()

# TABLE: Top 6 Balances Stats
print("\n=== TOP 6 BALANCE FIELDS ===")
top_bal_stats = df[top_bal].describe().T[["mean", "50%", "min", "max"]]
top_bal_stats.columns = ["Mean", "Median", "Min", "Max"]
top_bal_stats = top_bal_stats.round(2)
print(top_bal_stats.to_string())


# %% Cell 14: Credit & Risk
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Credit Score Range
df["CREDIT_SCORE_RNG"].value_counts().sort_index().plot(kind="bar", ax=axes[0], color="navy")
axes[0].set_title("Credit Score Range")
axes[0].tick_params(axis='x', rotation=45)

# Delinquency
dlqy = df["DLQY_IND"].value_counts()
axes[1].bar(["No Delinquency", "Delinquent"], [dlqy.get(0, 0), dlqy.get(1, 0)], color=["seagreen", "crimson"])
axes[1].set_title("Delinquency Indicator")

# Credit Phase
df["CREDIT_PHASE_SEG_CD"].value_counts().plot(kind="barh", ax=axes[2], color="darkorange")
axes[2].set_title("Credit Phase")

plt.tight_layout()
plt.show()

# TABLE: Credit Score Range
print("\n=== CREDIT SCORE RANGE ===")
credit_df = df["CREDIT_SCORE_RNG"].value_counts().sort_index().reset_index()
credit_df.columns = ["Credit Score Range", "Count"]
credit_df["Pct"] = (credit_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(credit_df.to_string(index=False))

# TABLE: Delinquency
print("\n=== DELINQUENCY ===")
dlqy_df = pd.DataFrame({
    "Status": ["No Delinquency", "Delinquent"],
    "Count": [dlqy.get(0, 0), dlqy.get(1, 0)],
    "Pct": [(dlqy.get(0, 0)/len(df)*100), (dlqy.get(1, 0)/len(df)*100)]
})
dlqy_df["Pct"] = dlqy_df["Pct"].round(1).astype(str) + "%"
print(dlqy_df.to_string(index=False))

# TABLE: Credit Phase
print("\n=== CREDIT PHASE ===")
phase_df = df["CREDIT_PHASE_SEG_CD"].value_counts().reset_index()
phase_df.columns = ["Credit Phase", "Count"]
phase_df["Pct"] = (phase_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(phase_df.to_string(index=False))


# %% Cell 15: Profitability
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Profitability Segment
df["PROF_SEG_CD"].value_counts().plot(kind="bar", ax=axes[0], color="teal")
axes[0].set_title("Profitability Segment")

# Monthly Profitability
df["PROF_TOT_MONTHLY"].clip(
    lower=df["PROF_TOT_MONTHLY"].quantile(0.05),
    upper=df["PROF_TOT_MONTHLY"].quantile(0.95)
).hist(bins=30, ax=axes[1], color="seagreen", edgecolor="black")
axes[1].set_title("Monthly Profitability (5th-95th pctl)")

# Annual Profitability
df["PROF_TOT_ANNUAL"].clip(
    lower=df["PROF_TOT_ANNUAL"].quantile(0.05),
    upper=df["PROF_TOT_ANNUAL"].quantile(0.95)
).hist(bins=30, ax=axes[2], color="coral", edgecolor="black")
axes[2].set_title("Annual Profitability (5th-95th pctl)")

plt.tight_layout()
plt.show()

# TABLE: Profitability Segment
print("\n=== PROFITABILITY SEGMENT ===")
prof_df = df["PROF_SEG_CD"].value_counts().reset_index()
prof_df.columns = ["Prof Segment", "Count"]
prof_df["Pct"] = (prof_df["Count"] / len(df) * 100).round(1).astype(str) + "%"
print(prof_df.to_string(index=False))

# TABLE: Profitability Stats
print("\n=== PROFITABILITY STATS ===")
prof_stats = df[["PROF_TOT_MONTHLY", "PROF_TOT_ANNUAL"]].describe().T[["mean", "50%", "min", "max"]]
prof_stats.columns = ["Mean", "Median", "Min", "Max"]
prof_stats = prof_stats.round(2)
print(prof_stats.to_string())


# %% Cell 16: Digital Engagement
fig, axes = plt.subplots(1, 3, figsize=(14, 4))

# OLB Enrolled
olb = df["OLB_ENROLLED_IND"].value_counts()
axes[0].bar(["Not Enrolled", "Enrolled"], [olb.get(0, 0), olb.get(1, 0)], color=["salmon", "seagreen"])
axes[0].set_title("Online Banking Enrolled")

# Active Email
email = df["ACTIVE_EMAIL_IND"].value_counts()
axes[1].bar(["No Email", "Active Email"], [email.get(0, 0), email.get(1, 0)], color=["salmon", "seagreen"])
axes[1].set_title("Active Email")

# Mobile Auth Count
df["MOBILE_AUTH_MOB_CNT"].clip(upper=20).hist(bins=20, ax=axes[2], color="steelblue", edgecolor="black")
axes[2].set_title("Mobile Auth Count (capped at 20)")

plt.tight_layout()
plt.show()

# TABLE: OLB Enrolled
print("\n=== ONLINE BANKING ENROLLED ===")
olb_df = pd.DataFrame({
    "Status": ["Not Enrolled", "Enrolled"],
    "Count": [olb.get(0, 0), olb.get(1, 0)],
    "Pct": [(olb.get(0, 0)/len(df)*100), (olb.get(1, 0)/len(df)*100)]
})
olb_df["Pct"] = olb_df["Pct"].round(1).astype(str) + "%"
print(olb_df.to_string(index=False))

# TABLE: Active Email
print("\n=== ACTIVE EMAIL ===")
email_df = pd.DataFrame({
    "Status": ["No Email", "Active Email"],
    "Count": [email.get(0, 0), email.get(1, 0)],
    "Pct": [(email.get(0, 0)/len(df)*100), (email.get(1, 0)/len(df)*100)]
})
email_df["Pct"] = email_df["Pct"].round(1).astype(str) + "%"
print(email_df.to_string(index=False))

# TABLE: Mobile Auth Stats
print("\n=== MOBILE AUTH STATS ===")
mobile_stats = df["MOBILE_AUTH_MOB_CNT"].describe()[["mean", "50%", "min", "max"]].round(2)
mobile_stats.index = ["Mean", "Median", "Min", "Max"]
print(mobile_stats.to_string())


# %% Cell 17: Cross-tab - Profitability by Generation
cross1 = pd.crosstab(df["GENERATION"], df["PROF_SEG_CD"], normalize="index") * 100

plt.figure(figsize=(12, 6))
cross1.plot(kind="bar", stacked=True, colormap="viridis", figsize=(12, 6))
plt.title("Profitability Segment by Generation (%)")
plt.ylabel("% of Generation")
plt.xlabel("Generation")
plt.legend(title="Prof Segment", bbox_to_anchor=(1.05, 1))
plt.tight_layout()
plt.show()

# TABLE: Cross-tab Profitability by Generation
print("\n=== PROFITABILITY BY GENERATION (%) ===")
cross1_rounded = cross1.round(1)
print(cross1_rounded.to_string())

# TABLE: Cross-tab Counts
print("\n=== PROFITABILITY BY GENERATION (COUNTS) ===")
cross1_counts = pd.crosstab(df["GENERATION"], df["PROF_SEG_CD"])
print(cross1_counts.to_string())


# %% Cell 18: Cross-tab - Product Holdings by Credit Score
cross2 = df.groupby("CREDIT_SCORE_RNG")[["LOAN_TOT_IND", "MORTGAGE_RESID_TOT_IND", "CC_VISA_ALL_TOT_IND"]].mean() * 100

cross2.plot(kind="bar", figsize=(12, 5), colormap="Set2")
plt.title("Product Holdings by Credit Score (%)")
plt.ylabel("% with Product")
plt.xlabel("Credit Score Range")
plt.legend(["Loan", "Mortgage", "Visa CC"])
plt.tight_layout()
plt.show()

# TABLE: Product Holdings by Credit Score
print("\n=== PRODUCT HOLDINGS BY CREDIT SCORE (%) ===")
cross2.columns = ["Loan %", "Mortgage %", "Visa CC %"]
cross2_rounded = cross2.round(1)
print(cross2_rounded.to_string())


# %% Cell 19: Summary Stats
print("\n" + "="*50)
print("FINAL SUMMARY")
print("="*50)
summary_data = {
    "Metric": [
        "Total Clients",
        "Active Clients",
        "Active %",
        "Avg Products per Client",
        "Avg Tenure (years)",
        "Avg Monthly Profitability",
        "Avg Annual Profitability",
        "Delinquency Rate",
        "OLB Enrollment Rate",
        "Active Email Rate"
    ],
    "Value": [
        len(df),
        df['IS_ACTIVE'].sum(),
        f"{df['IS_ACTIVE'].mean()*100:.1f}%",
        f"{df['ACTV_PROD_CNT'].mean():.1f}",
        f"{df['TENURE_RBC_YEARS'].mean():.1f}",
        f"${df['PROF_TOT_MONTHLY'].mean():.2f}",
        f"${df['PROF_TOT_ANNUAL'].mean():.2f}",
        f"{df['DLQY_IND'].mean()*100:.1f}%",
        f"{df['OLB_ENROLLED_IND'].mean()*100:.1f}%",
        f"{df['ACTIVE_EMAIL_IND'].mean()*100:.1f}%"
    ]
}
summary_df = pd.DataFrame(summary_data)
print(summary_df.to_string(index=False))
