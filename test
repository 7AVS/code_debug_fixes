# %% Cell 1: Setup
from pyspark.sql import functions as F
from pyspark.sql.functions import broadcast, when, col, max as spark_max, count

vvd_mne = ['VCN', 'VDA', 'VDO', 'VDT', 'VUI', 'VUT', 'VAW']


# %% Cell 2: Read Client List (Base)
client_list = spark.read.csv(
    "/user/427966379/VVD_SRF_LIST.csv",
    header=True
).select("CLNT_NO").distinct()

print(f"Total clients: {client_list.count()}")


# %% Cell 3: Get UCP Fields (3 fields only)
ucp_fields = spark.read.parquet(
    "/prod/sz/tsz/00172/data/ucp4/MONTH_END_DATE=2025-11-30"
).select("CLNT_NO", "ACTIVE_EMAIL_IND", "OLB_ENROLLED_IND", "MOBILE_AUTH_CNT")

# Join to client list
client_ucp = client_list.join(broadcast(ucp_fields), on="CLNT_NO", how="left")


# %% Cell 4: Read Tactic Data (VVD only)
years = ["2024", "2025"]
paths = [f"/prod/sz/tsz/00150/cc/DTZTA_T_TACTIC_EVNT_HIST/EVNT_STRT_DT={year}*" for year in years]

tactic = spark.read.option("basePath", "/prod/sz/tsz/00150/cc/DTZTA_T_TACTIC_EVNT_HIST/") \
    .parquet(*paths) \
    .withColumn("MNE", F.substring(F.col("TACTIC_ID"), 8, 3)) \
    .withColumn("CLNT_NO", F.regexp_replace(F.trim(F.col("TACTIC_EVNT_ID")), "^0+", "")) \
    .filter(F.col("MNE").isin(vvd_mne)) \
    .select("CLNT_NO", "MNE", "TREATMT_STRT_DT")

# Join to client list only
tactic_filtered = tactic.join(broadcast(client_list), on="CLNT_NO", how="inner")


# %% Cell 5: Pivot - Count and Last Date per MNE
# Count per MNE
count_pivot = tactic_filtered.groupBy("CLNT_NO").pivot("MNE", vvd_mne).agg(
    count("*")
).na.fill(0)

# Rename columns to _COUNT
for mne in vvd_mne:
    count_pivot = count_pivot.withColumnRenamed(mne, f"{mne}_COUNT")

# Last date per MNE
date_pivot = tactic_filtered.groupBy("CLNT_NO").pivot("MNE", vvd_mne).agg(
    spark_max("TREATMT_STRT_DT")
)

# Rename columns to _LAST_DATE
for mne in vvd_mne:
    date_pivot = date_pivot.withColumnRenamed(mne, f"{mne}_LAST_DATE")


# %% Cell 6: Combine Everything
# Join count and date pivots
tactic_combined = count_pivot.join(date_pivot, on="CLNT_NO", how="outer")

# Join to client_ucp (base)
final_output = client_ucp.join(tactic_combined, on="CLNT_NO", how="left")

# Fill nulls for counts
count_cols = [f"{mne}_COUNT" for mne in vvd_mne]
final_output = final_output.na.fill(0, count_cols)

# Create VVD_EVER_FLAG
final_output = final_output.withColumn(
    "VVD_EVER_FLAG",
    when(
        (col("VCN_COUNT") > 0) | (col("VDA_COUNT") > 0) | (col("VDO_COUNT") > 0) |
        (col("VDT_COUNT") > 0) | (col("VUI_COUNT") > 0) | (col("VUT_COUNT") > 0) |
        (col("VAW_COUNT") > 0),
        1
    ).otherwise(0)
)

# Reorder columns
final_output = final_output.select(
    "CLNT_NO",
    "ACTIVE_EMAIL_IND",
    "OLB_ENROLLED_IND",
    "MOBILE_AUTH_CNT",
    "VVD_EVER_FLAG",
    "VCN_COUNT", "VCN_LAST_DATE",
    "VDA_COUNT", "VDA_LAST_DATE",
    "VDO_COUNT", "VDO_LAST_DATE",
    "VDT_COUNT", "VDT_LAST_DATE",
    "VUI_COUNT", "VUI_LAST_DATE",
    "VUT_COUNT", "VUT_LAST_DATE",
    "VAW_COUNT", "VAW_LAST_DATE"
)

print(f"Final output rows: {final_output.count()}")
print(f"Final output columns: {len(final_output.columns)}")
final_output.show(20, truncate=False)


# %% Cell 7: Save to CSV
final_output.coalesce(1).write.csv(
    "/user/427966379/vvd_srf_client_campaign_output",
    header=True,
    mode="overwrite"
)

print("CSV saved to /user/427966379/vvd_srf_client_campaign_output")
This gives you:
All 438K clients
3 UCP fields (email, OLB, mobile auth)
VVD_EVER_FLAG
7 count columns (one per MNE)
7 last date columns (one per MNE)
Want me to put this in a file?