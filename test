/* ========================================================================= */
/* STUDENT SEGMENT DIAGNOSTIC - Find the Real Data Structure               */
/* Purpose: Investigate why student segment parsing returns all zeros       */
/* ========================================================================= */

/* STEP 1: Look at raw TACTIC_DECISN_VRB_INFO field */
proc sql;
    %connectsql;
    create table raw_tactic_info as
    select * from connection to teradata (
        SELECT DISTINCT
            tactic.TACTIC_ID,
            tactic.CLNT_NO,
            tactic.TACTIC_DECISN_VRB_INFO
        FROM DG6V01.TACTIC_EVNT_IP_AR_HIST AS tactic
        WHERE TACTIC.tactic_id IN ('2024196SLC', '2025196SLC', '2025227SLC')
        AND tactic.TACTIC_DECISN_VRB_INFO IS NOT NULL
        ORDER BY TACTIC.TACTIC_ID, TACTIC.CLNT_NO
    );
quit;

/* STEP 2: Sample the actual content */
/* Add length calculation in SAS */
data raw_tactic_info;
    set raw_tactic_info;
    info_length = length(TACTIC_DECISN_VRB_INFO);
run;

proc print data=raw_tactic_info (obs=10);
    title "DIAGNOSTIC: Sample of TACTIC_DECISN_VRB_INFO Content";
    var tactic_id clnt_no info_length TACTIC_DECISN_VRB_INFO;
run;

/* STEP 3: Check what strings actually exist in the data */
proc sql;
    title "DIAGNOSTIC: Search String Analysis";
    select 
        TACTIC_ID,
        count(*) as total_records,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'Student NG') > 0 then 1 else 0 end) as has_student_ng,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'Student SB') > 0 then 1 else 0 end) as has_student_sb,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'Student IR') > 0 then 1 else 0 end) as has_student_ir,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'EM Ind:') > 0 then 1 else 0 end) as has_em_ind,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'OLB Ind:') > 0 then 1 else 0 end) as has_olb_ind,
        sum(case when index(TACTIC_DECISN_VRB_INFO, 'Grad Date:') > 0 then 1 else 0 end) as has_grad_date,
        sum(case when TACTIC_DECISN_VRB_INFO is null then 1 else 0 end) as null_records
    from raw_tactic_info
    group by TACTIC_ID
    order by TACTIC_ID;
quit;

/* STEP 4: Test the parsing logic with actual data */
data parsing_test;
    set raw_tactic_info;
    
    /* Test current parsing logic */
    if tactic_id = '2024196SLC' then 
        student_ng_test = trim(substr(TACTIC_DECISN_VRB_INFO, index(TACTIC_DECISN_VRB_INFO, 'Student NG')+13, 1));
    else if tactic_id = '2025196SLC' then
        student_ng_test = trim(substr(TACTIC_DECISN_VRB_INFO, index(TACTIC_DECISN_VRB_INFO, 'Student NG')+12, 1));
    
    /* Also test different offset positions */
    student_ng_pos = index(TACTIC_DECISN_VRB_INFO, 'Student NG');
    if student_ng_pos > 0 then do;
        student_ng_extract_10 = substr(TACTIC_DECISN_VRB_INFO, student_ng_pos+10, 5);
        student_ng_extract_11 = substr(TACTIC_DECISN_VRB_INFO, student_ng_pos+11, 5);
        student_ng_extract_12 = substr(TACTIC_DECISN_VRB_INFO, student_ng_pos+12, 5);
        student_ng_extract_13 = substr(TACTIC_DECISN_VRB_INFO, student_ng_pos+13, 5);
    end;
    
    keep tactic_id clnt_no TACTIC_DECISN_VRB_INFO student_ng_pos student_ng_test 
         student_ng_extract_10 student_ng_extract_11 student_ng_extract_12 student_ng_extract_13;
run;

/* STEP 5: Show parsing results */
proc print data=parsing_test (obs=20);
    title "DIAGNOSTIC: Student NG Parsing Test Results";
    where student_ng_pos > 0;
run;

/* STEP 6: Check if there are alternative fields with student info */
proc sql;
    %connectsql;
    create table alternative_fields as
    select * from connection to teradata (
        SELECT DISTINCT
            tactic.TACTIC_ID,
            count(*) as record_count
        FROM DG6V01.TACTIC_EVNT_IP_AR_HIST AS tactic
        WHERE TACTIC.tactic_id IN ('2024196SLC', '2025196SLC', '2025227SLC')
        GROUP BY tactic.TACTIC_ID
    );
quit;

proc sql;
    title "DIAGNOSTIC: Record Counts by Tactic ID";
    select * from alternative_fields;
quit;

%put =======================================================================;
%put STUDENT SEGMENT DIAGNOSTIC COMPLETE;
%put =======================================================================;
%put Check the results to see:;
%put 1. What is actually in TACTIC_DECISN_VRB_INFO field;
%put 2. Whether our search strings exist in the data;
%put 3. What the correct parsing offsets should be;
%put 4. Whether student segment data exists at all;
%put =======================================================================;
