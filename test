"""
VVD Campaign Deployment Inventory
Count waves/cohorts per campaign to plan visualizations
"""

from pyspark.sql import SparkSession
from pyspark.sql import functions as F

# Initialize Spark
spark = SparkSession.builder \
    .appName("VVD Deployment Inventory") \
    .getOrCreate()

# Load tactic
tactic = spark.read.parquet("/user/427966379/tactic.parquet")

print("="*70)
print("VVD CAMPAIGN DEPLOYMENT INVENTORY")
print("="*70)

# Count deployments (unique TREATMT_STRT_DT) per MNE
print("\n1. DEPLOYMENTS PER CAMPAIGN (Unique Treatment Start Dates)")
print("-"*70)

deployment_counts = tactic.groupBy("MNE").agg(
    F.countDistinct("TREATMT_STRT_DT").alias("NUM_DEPLOYMENTS"),
    F.count("*").alias("TOTAL_RECORDS"),
    F.countDistinct("CLNT_NO").alias("UNIQUE_CLIENTS"),
    F.min("TREATMT_STRT_DT").alias("FIRST_DEPLOYMENT"),
    F.max("TREATMT_STRT_DT").alias("LAST_DEPLOYMENT")
).orderBy("MNE")

deployment_counts.show(truncate=False)

# Detailed breakdown per campaign
print("\n2. DETAILED BREAKDOWN BY CAMPAIGN")
print("-"*70)

for mne in ["VCN", "VDA", "VDT", "VUI", "VUT", "VAW"]:
    print(f"\n>>> {mne} <<<")
    
    mne_data = tactic.filter(F.col("MNE") == mne)
    
    if mne_data.count() == 0:
        print(f"    No data found for {mne}")
        continue
    
    # Deployments by date
    deployments = mne_data.groupBy("TREATMT_STRT_DT").agg(
        F.count("*").alias("TOTAL_CLIENTS"),
        F.countDistinct("TST_GRP_CD").alias("NUM_TEST_GROUPS"),
        F.sum(F.when(F.col("TST_GRP_CD") == "TG4", 1).otherwise(0)).alias("TEST_COUNT"),
        F.sum(F.when(F.col("TST_GRP_CD") != "TG4", 1).otherwise(0)).alias("CONTROL_COUNT")
    ).orderBy("TREATMT_STRT_DT")
    
    deployments.show(50, truncate=False)

# Summary for planning
print("\n3. SUMMARY FOR VISUALIZATION PLANNING")
print("-"*70)

summary = tactic.groupBy("MNE").agg(
    F.countDistinct("TREATMT_STRT_DT").alias("WAVES")
).orderBy("MNE")

summary_list = summary.collect()

print("\n| MNE | # Waves | Recommended Plot Style |")
print("|-----|---------|------------------------|")
for row in summary_list:
    waves = row["WAVES"]
    if waves <= 6:
        style = "Single plot, all cohorts"
    elif waves <= 12:
        style = "Single plot OR grid (3x4)"
    else:
        style = "Consider filtering recent only"
    print(f"| {row['MNE']} | {waves:>7} | {style} |")

print("\n" + "="*70)
print("INVENTORY COMPLETE")
print("="*70)
