/* ========================================================================= */
/* EMAIL VINTAGE DIAGNOSTIC - Find the Data Issues                         */
/* PREREQUISITE: Run new_vintage_complete.sas first                        */
/* ========================================================================= */

/* STEP 1: Check what's in tactic_details */
proc sql;
    title "DIAGNOSTIC: What cohorts and test groups exist in tactic_details?";
    select 
        TACTIC_ID,
        TST_GRP_CD,
        count(distinct CLNT_NO) as client_count
    from tactic_details
    group by TACTIC_ID, TST_GRP_CD
    order by TACTIC_ID, TST_GRP_CD;
quit;

/* STEP 2: Check email data by cohort */
proc sql;
    %connectsql;
    CREATE TABLE email_check AS
    SELECT * FROM CONNECTION TO TERADATA(
        SELECT DISTINCT
            FEEDBACK_MASTER.TREATMENT_ID,
            count(distinct FEEDBACK_MASTER.CLNT_NO) as email_clients
        FROM DTZV01.VENDOR_FEEDBACK_MASTER FEEDBACK_MASTER
        WHERE FEEDBACK_MASTER.TREATMENT_ID IN ('2024196SLC', '2025196SLC', '2025227SLC')
        GROUP BY 1
        ORDER BY 1
    );
QUIT;

proc sql;
    title "DIAGNOSTIC: What cohorts have email data?";
    select * from email_check;
quit;

/* STEP 3: Check if email data joins properly to tactic_details */
proc sql;
    title "DIAGNOSTIC: How many clients have both tactic and email data?";
    select 
        t.TACTIC_ID,
        t.TST_GRP_CD,
        count(distinct t.CLNT_NO) as tactic_clients,
        sum(case when e.TREATMENT_ID is not null then 1 else 0 end) as clients_with_email
    from tactic_details as t
    left join email_check_detail as e
        on t.TACTIC_ID = e.TREATMENT_ID and t.CLNT_NO = e.CLNT_NO
    group by t.TACTIC_ID, t.TST_GRP_CD
    order by t.TACTIC_ID, t.TST_GRP_CD;
quit;

/* STEP 4: Get detailed email data for join check */
proc sql;
    %connectsql;
    CREATE TABLE email_check_detail AS
    SELECT * FROM CONNECTION TO TERADATA(
        SELECT DISTINCT
            FEEDBACK_MASTER.TREATMENT_ID,
            FEEDBACK_MASTER.CLNT_NO
        FROM DTZV01.VENDOR_FEEDBACK_MASTER FEEDBACK_MASTER
        WHERE FEEDBACK_MASTER.TREATMENT_ID IN ('2024196SLC', '2025196SLC', '2025227SLC')
    );
QUIT;

/* Re-run the join check */
proc sql;
    title "DIAGNOSTIC: Tactic vs Email Data Match";
    select 
        t.TACTIC_ID,
        t.TST_GRP_CD,
        count(distinct t.CLNT_NO) as tactic_clients,
        sum(case when e.TREATMENT_ID is not null then 1 else 0 end) as clients_with_email,
        calculated clients_with_email / calculated tactic_clients * 100 as match_pct format=8.1
    from tactic_details as t
    left join email_check_detail as e
        on t.TACTIC_ID = e.TREATMENT_ID and t.CLNT_NO = e.CLNT_NO
    group by t.TACTIC_ID, t.TST_GRP_CD
    order by t.TACTIC_ID, t.TST_GRP_CD;
quit;

%put =======================================================================;
%put EMAIL DIAGNOSTIC COMPLETE;
%put =======================================================================;
%put Check the results above to identify:;
%put 1. Which cohorts exist in tactic_details;
%put 2. Which cohorts have email data;
%put 3. Match rates between tactic and email data;
%put =======================================================================;
