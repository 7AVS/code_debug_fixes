# =============================================================================
# UCP4 EDA SECTION - CORRECTED
# =============================================================================
# Run after Cell 7 (Convert to Pandas)
# =============================================================================

# %% Cell 8: Client Overview
fig, axes = plt.subplots(1, 3, figsize=(14, 4))

# Total & Active
active_counts = df["IS_ACTIVE"].value_counts()
axes[0].bar(["Inactive", "Active"], [active_counts.get(0, 0), active_counts.get(1, 0)], color=["salmon", "seagreen"])
axes[0].set_title(f"Active vs Inactive\n(Total: {len(df)})")
axes[0].set_ylabel("Count")

# Months of data
df["MONTHS_WITH_DATA"].value_counts().sort_index().plot(kind="bar", ax=axes[1], color="steelblue")
axes[1].set_title("Months of Data per Client")
axes[1].set_xlabel("Months")
axes[1].set_ylabel("Count")

# Active product count distribution
df["ACTV_PROD_CNT"].clip(upper=10).value_counts().sort_index().plot(kind="bar", ax=axes[2], color="darkorange")
axes[2].set_title("Active Product Count")
axes[2].set_xlabel("Products (capped at 10)")
axes[2].set_ylabel("Count")

plt.tight_layout()
plt.show()


# %% Cell 9: Demographics
fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# Generation
df["GENERATION"].value_counts().plot(kind="barh", ax=axes[0, 0], color="teal")
axes[0, 0].set_title("Generation")

# Age Range
df["AGE_RNG"].value_counts().sort_index().plot(kind="bar", ax=axes[0, 1], color="coral")
axes[0, 1].set_title("Age Range")
axes[0, 1].tick_params(axis='x', rotation=45)

# Gender
df["SEX_SEG_CD"].value_counts().plot(kind="bar", ax=axes[1, 0], color="mediumpurple")
axes[1, 0].set_title("Gender")

# Top 10 FSA
df["FSA_CD"].value_counts().head(10).plot(kind="barh", ax=axes[1, 1], color="olive")
axes[1, 1].set_title("Top 10 FSA (Postal Areas)")

plt.tight_layout()
plt.show()


# %% Cell 10: Tenure & Relationship
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Tenure Range - CORRECTED: TENURE_RBC_RNG (not RNGS)
df["TENURE_RBC_RNG"].value_counts().plot(kind="bar", ax=axes[0], color="steelblue")
axes[0].set_title("Tenure Range")
axes[0].tick_params(axis='x', rotation=45)

# Avg Tenure Years
axes[1].hist(df["TENURE_RBC_YEARS"].dropna(), bins=20, color="seagreen", edgecolor="black")
axes[1].set_title("Tenure Years Distribution")
axes[1].set_xlabel("Years")

# Relationship Type
df["REL_TP_SEG_CD"].value_counts().plot(kind="barh", ax=axes[2], color="darkorange")
axes[2].set_title("Relationship Type")

plt.tight_layout()
plt.show()


# %% Cell 11: Product Penetration
ind_fields = [c for c in df.columns if "_IND" in c]
penetration = df[ind_fields].apply(lambda x: (x == 1).sum() / len(df) * 100).sort_values(ascending=True)

plt.figure(figsize=(10, 8))
penetration.plot(kind="barh", color="teal")
plt.title("Product Penetration (%)")
plt.xlabel("% of Clients")
plt.tight_layout()
plt.show()


# %% Cell 12: Balance Summary
bal_fields = [c for c in df.columns if "_BAL" in c]
bal_summary = df[bal_fields].describe().T[["mean", "50%", "min", "max"]]
bal_summary.columns = ["Mean", "Median", "Min", "Max"]
bal_summary = bal_summary.round(2)

print("Balance Summary:")
print(bal_summary)


# %% Cell 13: Balance Distributions (Top 6)
top_bal = df[bal_fields].mean().sort_values(ascending=False).head(6).index.tolist()

fig, axes = plt.subplots(2, 3, figsize=(15, 8))
axes = axes.flatten()

for i, field in enumerate(top_bal):
    df[field].clip(upper=df[field].quantile(0.95)).hist(bins=30, ax=axes[i], color="steelblue", edgecolor="black")
    axes[i].set_title(field)
    axes[i].set_xlabel("Balance (capped 95th pctl)")

plt.tight_layout()
plt.show()


# %% Cell 14: Credit & Risk
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Credit Score Range
df["CREDIT_SCORE_RNG"].value_counts().sort_index().plot(kind="bar", ax=axes[0], color="navy")
axes[0].set_title("Credit Score Range")
axes[0].tick_params(axis='x', rotation=45)

# Delinquency
dlqy = df["DLQY_IND"].value_counts()
axes[1].bar(["No Delinquency", "Delinquent"], [dlqy.get(0, 0), dlqy.get(1, 0)], color=["seagreen", "crimson"])
axes[1].set_title("Delinquency Indicator")

# Credit Phase
df["CREDIT_PHASE_SEG_CD"].value_counts().plot(kind="barh", ax=axes[2], color="darkorange")
axes[2].set_title("Credit Phase")

plt.tight_layout()
plt.show()


# %% Cell 15: Profitability
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# Profitability Segment
df["PROF_SEG_CD"].value_counts().plot(kind="bar", ax=axes[0], color="teal")
axes[0].set_title("Profitability Segment")

# Monthly Profitability
df["PROF_TOT_MONTHLY"].clip(
    lower=df["PROF_TOT_MONTHLY"].quantile(0.05),
    upper=df["PROF_TOT_MONTHLY"].quantile(0.95)
).hist(bins=30, ax=axes[1], color="seagreen", edgecolor="black")
axes[1].set_title("Monthly Profitability (5th-95th pctl)")

# Annual Profitability
df["PROF_TOT_ANNUAL"].clip(
    lower=df["PROF_TOT_ANNUAL"].quantile(0.05),
    upper=df["PROF_TOT_ANNUAL"].quantile(0.95)
).hist(bins=30, ax=axes[2], color="coral", edgecolor="black")
axes[2].set_title("Annual Profitability (5th-95th pctl)")

plt.tight_layout()
plt.show()


# %% Cell 16: Digital Engagement
fig, axes = plt.subplots(1, 3, figsize=(14, 4))

# OLB Enrolled
olb = df["OLB_ENROLLED_IND"].value_counts()
axes[0].bar(["Not Enrolled", "Enrolled"], [olb.get(0, 0), olb.get(1, 0)], color=["salmon", "seagreen"])
axes[0].set_title("Online Banking Enrolled")

# Active Email
email = df["ACTIVE_EMAIL_IND"].value_counts()
axes[1].bar(["No Email", "Active Email"], [email.get(0, 0), email.get(1, 0)], color=["salmon", "seagreen"])
axes[1].set_title("Active Email")

# Mobile Auth Count
df["MOBILE_AUTH_MOB_CNT"].clip(upper=20).hist(bins=20, ax=axes[2], color="steelblue", edgecolor="black")
axes[2].set_title("Mobile Auth Count (capped at 20)")

plt.tight_layout()
plt.show()


# %% Cell 17: Cross-tab - Profitability by Generation
cross1 = pd.crosstab(df["GENERATION"], df["PROF_SEG_CD"], normalize="index") * 100

plt.figure(figsize=(12, 6))
cross1.plot(kind="bar", stacked=True, colormap="viridis", figsize=(12, 6))
plt.title("Profitability Segment by Generation (%)")
plt.ylabel("% of Generation")
plt.xlabel("Generation")
plt.legend(title="Prof Segment", bbox_to_anchor=(1.05, 1))
plt.tight_layout()
plt.show()


# %% Cell 18: Cross-tab - Product Holdings by Credit Score
cross2 = df.groupby("CREDIT_SCORE_RNG")[["LOAN_TOT_IND", "MORTGAGE_RESID_TOT_IND", "CC_VISA_ALL_TOT_IND"]].mean() * 100

cross2.plot(kind="bar", figsize=(12, 5), colormap="Set2")
plt.title("Product Holdings by Credit Score (%)")
plt.ylabel("% with Product")
plt.xlabel("Credit Score Range")
plt.legend(["Loan", "Mortgage", "Visa CC"])
plt.tight_layout()
plt.show()


# %% Cell 19: Summary Stats
print("=== SUMMARY ===")
print(f"Total Clients: {len(df)}")
print(f"Active Clients: {df['IS_ACTIVE'].sum()} ({df['IS_ACTIVE'].mean()*100:.1f}%)")
print(f"Avg Products per Client: {df['ACTV_PROD_CNT'].mean():.1f}")
print(f"Avg Tenure: {df['TENURE_RBC_YEARS'].mean():.1f} years")
print(f"Avg Monthly Profitability: ${df['PROF_TOT_MONTHLY'].mean():.2f}")
print(f"Delinquency Rate: {df['DLQY_IND'].mean()*100:.1f}%")
print(f"OLB Enrollment: {df['OLB_ENROLLED_IND'].mean()*100:.1f}%")
